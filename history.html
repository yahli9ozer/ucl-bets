<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kicker Hall of Fame </title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="components/navbar.js"></script>
</head>
<body class="bg-gray-100 text-right">
    
    <custom-navbar></custom-navbar>

    <main class="container mx-auto px-4 py-8">
        <div class="max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-feather="trello" class="text-purple-600"></i> 转  
                </h1>
                <a href="index.html" class="bg-white border px-4 py-2 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2">
                    <i data-feather="arrow-right"></i> 专 砖拽
                </a>
            </div>

            <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-center whitespace-nowrap">
                        <thead class="bg-slate-800 text-white">
                            <tr id="table-head-row">
                                <th class="p-4 text-right">砖转转祝</th>
                                <th class="p-4 bg-slate-700 text-xl">住"</th>
                                </tr>
                        </thead>
                        <tbody id="history-body" class="text-gray-800 font-bold divide-y">
                            </tbody>
                    </table>
                </div>
            </div>
            <p class="text-center text-gray-400 mt-8 text-xs">转 转注  驻注 砖 住专 专</p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // !!! PASTE CONFIG HERE !!!
        const firebaseConfig = {
           apiKey: "AIzaSyCICNrNm1pxT3FjAHQPRCtXM-ei63dT8yY",
           authDomain: "ucl-bets.firebaseapp.com",
           databaseURL: "https://ucl-bets-default-rtdb.firebaseio.com",
           projectId: "ucl-bets",
           storageBucket: "ucl-bets.firebasestorage.app",
           messagingSenderId: "520474072792",
           appId: "1:520474072792:web:0beb13263d2b9a03d0a9ad"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        feather.replace();

        let users = {};
        let history = {};

        // Fetch Data
        const usersRef = ref(db, 'users');
        const historyRef = ref(db, 'history');

        // Load Users First
        onValue(usersRef, (uSnap) => {
            users = uSnap.val() || {};
            // Load History
            onValue(historyRef, (hSnap) => {
                history = hSnap.val() || {};
                renderTable();
            });
        });

        function renderTable() {
            const theadRow = document.getElementById('table-head-row');
            const tbody = document.getElementById('history-body');
            
            // 1. Prepare Columns (Rounds)
            // Clear existing round headers (keep first 2: Name, Total)
            while (theadRow.children.length > 2) {
                theadRow.removeChild(theadRow.lastChild);
            }

            const rounds = Object.keys(history).map(key => ({
                id: key,
                ...history[key]
            })).sort((a, b) => a.timestamp - b.timestamp); // Sort by date

            // Add Headers for rounds
            rounds.forEach(r => {
                const th = document.createElement('th');
                th.className = "p-4 font-normal text-sm text-gray-300";
                th.innerText = r.name;
                theadRow.appendChild(th);
            });

            // 2. Prepare Rows (Users)
            const userStats = Object.keys(users).map(uid => {
                const userObj = { 
                    id: uid, 
                    name: users[uid].name, 
                    total: 0,
                    roundPoints: [] 
                };

                // Sum up points
                rounds.forEach(r => {
                    const pts = (r.results && r.results[uid]) ? r.results[uid] : 0;
                    userObj.total += pts;
                    userObj.roundPoints.push(pts);
                });

                return userObj;
            });

            // Sort by Total Points
            userStats.sort((a, b) => b.total - a.total);

            // Render Body
            tbody.innerHTML = '';
            userStats.forEach((u, i) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition";
                
                // Color for rank
                let rankColor = "text-gray-500";
                let rowBg = "";
                if (i === 0) { rankColor = "text-yellow-500"; rowBg="bg-yellow-50/50"; }
                if (i === 1) rankColor = "text-gray-400";
                if (i === 2) rankColor = "text-orange-400";
                
                tr.className += " " + rowBg;

                // Name Cell
                let html = `
                    <td class="p-4 text-right flex items-center gap-3">
                        <span class="font-bold text-lg ${rankColor}">#${i+1}</span>
                        <span>${u.name}</span>
                    </td>
                    <td class="p-4 text-xl text-blue-600 bg-gray-50/80 font-black">${u.total}</td>
                `;

                // Round Cells
                u.roundPoints.forEach(pts => {
                    let color = "text-gray-400";
                    if (pts > 0) color = "text-gray-800";
                    if (pts >= 10) color = "text-green-600 font-black"; // High score highlight
                    
                    html += `<td class="p-4 ${color}">${pts}</td>`;
                });

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
